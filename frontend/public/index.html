<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Manager - åº“å­˜ç›‘æ§</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŸ</text></svg>">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff4466;
            --accent-orange: #ffaa00;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 2.5em;
        }

        .logo-text h1 {
            font-size: 1.5em;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .stat-card h3 {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-card.in-stock .value { color: var(--accent-green); }
        .stat-card.out-of-stock .value { color: var(--accent-red); }
        .stat-card.total .value { color: var(--accent-cyan); }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .product-image {
            height: 200px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .product-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-in-stock {
            background: var(--accent-green);
            color: #000;
        }

        .badge-out-of-stock {
            background: var(--accent-red);
            color: #fff;
        }

        .badge-checking {
            background: var(--accent-orange);
            color: #000;
        }

        .foodguard-score {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .score-value {
            color: var(--accent-green);
            font-weight: 700;
        }

        .product-content {
            padding: 20px;
        }

        .product-brand {
            font-size: 0.85em;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }

        .product-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .product-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .product-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-price {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 10px;
        }

        .product-platform {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .platform-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .platform-link {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.8em;
            text-decoration: none;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .platform-link:hover {
            background: var(--accent-cyan);
            color: #000;
        }

        .platform-link.available {
            border: 1px solid var(--accent-green);
        }

        .platform-link.unavailable {
            border: 1px solid var(--accent-red);
            opacity: 0.6;
        }

        .alerts-section {
            margin-top: 40px;
        }

        .alert-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-card.restock {
            border-left-color: var(--accent-green);
        }

        .alert-card.price-drop {
            border-left-color: var(--accent-orange);
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 1.5em;
        }

        .alert-time {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1em;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.85em;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸŸ</span>
                <div class="logo-text">
                    <h1>Grocery Manager</h1>
                    <p>Premium Sardines & Mackerel Monitor</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span id="last-update">åŠ è½½ä¸­...</span>
                </div>
                <button class="btn btn-primary" id="refresh-btn" onclick="refreshData()">
                    <span>åˆ·æ–°</span>
                </button>
                <button class="btn btn-secondary" onclick="openSettings()">
                    âš™ï¸ è®¾ç½®
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="stats-grid">
            <div class="stat-card total">
                <h3>ç›‘æ§äº§å“</h3>
                <div class="value" id="stat-total">-</div>
            </div>
            <div class="stat-card in-stock">
                <h3>æœ‰è´§</h3>
                <div class="value" id="stat-available">-</div>
            </div>
            <div class="stat-card out-of-stock">
                <h3>ç¼ºè´§</h3>
                <div class="value" id="stat-unavailable">-</div>
            </div>
            <div class="stat-card">
                <h3>é¢„è®¡é‡‡è´­æ€»é¢</h3>
                <div class="value" style="color: var(--accent-orange);">S$<span id="stat-cost">-</span></div>
            </div>
        </div>

        <section>
            <h2 class="section-title">ğŸ“¦ ç›‘æ§åˆ—è¡¨</h2>
            <div class="products-grid" id="products-container">
                <div class="empty-state">
                    <h3>åŠ è½½äº§å“æ•°æ®...</h3>
                    <p>è¯·ç¨å€™</p>
                </div>
            </div>
        </section>

        <section class="alerts-section">
            <h2 class="section-title">ğŸ”” æœ€æ–°æé†’</h2>
            <div id="alerts-container">
                <div class="empty-state">
                    <p>æš‚æ— æé†’</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>Grocery Manager v1.0 | FoodGuard è¯„åˆ†ç³»ç»Ÿ | è‡ªåŠ¨ç›‘æ§æ¯4å°æ—¶æ›´æ–°</p>
        <p style="margin-top: 10px;">Powered by Claude Code</p>
    </footer>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è®¾ç½®</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <form id="settings-form" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>API æœåŠ¡å™¨åœ°å€</label>
                    <input type="url" id="api-url" placeholder="https://your-api.workers.dev" value="">
                </div>
                <div class="form-group">
                    <label>é‚®ä»¶é€šçŸ¥åœ°å€</label>
                    <input type="email" id="email-notify" placeholder="your@email.com">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ä¿å­˜è®¾ç½®</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨æ£€æŸ¥åº“å­˜...</p>
    </div>

    <script>
        // Product images mapping
        const PRODUCT_IMAGES = {
            "JosÃ© Gourmet": "https://www.fossaprovisions.com/cdn/shop/products/Jg_small_mack_oo-removebg-preview_1024x1024@2x.png",
            "The Stock Merchant": "https://cdn.shopify.com/s/files/1/0553/1521/products/TheStockMerchant-SardinesInExtraVirginOliveOil-120g_1024x1024.jpg",
            "Good Fish": "https://cdn.shopify.com/s/files/1/0278/8577/0734/products/sardines-olive-oil_1024x1024.jpg",
            "NURI": "https://m.media-amazon.com/images/I/71qWDGzL8ZL._SL1500_.jpg",
            "Ortiz": "https://m.media-amazon.com/images/I/71LvUjl5q2L._SL1500_.jpg",
            "RamÃ³n PeÃ±a": "https://www.conservasramonpena.com/wp-content/uploads/2021/04/sardinillas-aceite-oliva-16-20-piezas-linea-oro.png"
        };

        // Default fallback image
        const DEFAULT_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='50%25' x='50%25' text-anchor='middle' dominant-baseline='middle' font-size='50'%3EğŸŸ%3C/text%3E%3C/svg%3E";

        // Configuration
        let API_BASE_URL = localStorage.getItem('apiUrl') || '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            fetchData();
            // Auto-refresh every 5 minutes
            setInterval(fetchData, 5 * 60 * 1000);
        });

        function loadSettings() {
            const apiUrl = localStorage.getItem('apiUrl');
            const email = localStorage.getItem('notifyEmail');
            if (apiUrl) document.getElementById('api-url').value = apiUrl;
            if (email) document.getElementById('email-notify').value = email;
        }

        function saveSettings(e) {
            e.preventDefault();
            const apiUrl = document.getElementById('api-url').value;
            const email = document.getElementById('email-notify').value;

            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('notifyEmail', email);
            API_BASE_URL = apiUrl;

            closeSettings();
            fetchData();
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function fetchData() {
            // Try API first
            if (API_BASE_URL) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/watchlist`);
                    if (response.ok) {
                        const data = await response.json();
                        renderProducts(data.items);
                        renderAlerts(data.alerts || []);
                        updateStats(data.items);
                        updateLastChecked();
                        return;
                    }
                } catch (e) {
                    console.error('API fetch failed:', e);
                }
            }

            // Try loading from static JSON file
            try {
                const response = await fetch('./data/watchlist.json');
                if (response.ok) {
                    const data = await response.json();
                    const products = data.products.map(p => ({
                        ...p,
                        is_available_anywhere: Object.values(p.platform_products || {}).some(pp => pp.in_stock !== false),
                        current_best_price: Math.min(...Object.values(p.platform_products || {}).filter(pp => pp.price).map(pp => pp.price)) || null,
                        availability_status: Object.fromEntries(
                            Object.entries(p.platform_products || {}).map(([k, v]) => [k, { in_stock: v.in_stock !== false, price: v.price, url: v.url }])
                        )
                    }));
                    renderProducts(products);
                    renderAlerts([]);
                    updateStats(products);
                    document.getElementById('last-update').textContent = `æ•°æ®: ${new Date(data.last_updated).toLocaleDateString('zh-CN')}`;
                    return;
                }
            } catch (e) {
                console.error('Static JSON load failed:', e);
            }

            // Use mock data for demo
            renderMockData();
        }

        function renderMockData() {
            const mockProducts = [
                {
                    id: 1,
                    brand: "JosÃ© Gourmet",
                    name: "Small Mackerel in Olive Oil",
                    origin_country: "Portugal",
                    size: "120g",
                    foodguard_score: 10,
                    weekly_target_qty: 2,
                    current_best_price: 11.50,
                    current_best_platform: "morning_market",
                    is_available_anywhere: true,
                    availability_status: {
                        "fossa": { in_stock: true, price: 12.90, url: "https://www.fossaprovisions.com" },
                        "morning_market": { in_stock: true, price: 11.50, url: "#" }
                    },
                    notes: "Fair Tradeè®¤è¯ï¼Œè‰ºæœ¯åŒ…è£…"
                },
                {
                    id: 2,
                    brand: "The Stock Merchant",
                    name: "MSC Sardines in Organic EVOO",
                    origin_country: "Australia/Portugal",
                    size: "120g",
                    foodguard_score: 10,
                    weekly_target_qty: 3,
                    current_best_price: 9.48,
                    current_best_platform: "little_farms",
                    is_available_anywhere: false,
                    availability_status: {
                        "little_farms": { in_stock: false, price: 9.48, url: "#" }
                    },
                    notes: "MSC+æœ‰æœºåŒè®¤è¯"
                },
                {
                    id: 3,
                    brand: "Good Fish",
                    name: "Sardines in Organic EVOO",
                    origin_country: "Australia",
                    size: "120g",
                    foodguard_score: 10,
                    weekly_target_qty: 2,
                    current_best_price: null,
                    current_best_platform: null,
                    is_available_anywhere: false,
                    availability_status: {},
                    notes: "35%æœ‰æœºEVOOï¼ŒBPA-Free"
                },
                {
                    id: 4,
                    brand: "NURI",
                    name: "Spiced Sardines in Olive Oil",
                    origin_country: "Portugal",
                    size: "125g",
                    foodguard_score: 10,
                    weekly_target_qty: 2,
                    current_best_price: null,
                    current_best_platform: null,
                    is_available_anywhere: false,
                    availability_status: {
                        "lazada_sg": { in_stock: false, url: "https://www.lazada.sg/products/nuri-spiced-sardines-in-olive-oil-125g-i1224956803.html" },
                        "amazon_sg": { in_stock: false, url: "https://www.amazon.sg/nuri-sardines/s?k=nuri+sardines" }
                    },
                    notes: "ç»¿è‰²åŒ…è£…é¦™æ–™ç‰ˆå…¥å‘å¿…é€‰ï¼Œç›®å‰ç¼ºè´§ç›‘æ§ä¸­"
                },
                {
                    id: 5,
                    brand: "Ortiz",
                    name: "Sardinas a la Antigua",
                    origin_country: "Spain",
                    size: "140g",
                    foodguard_score: 9,
                    weekly_target_qty: 2,
                    current_best_price: 18.00,
                    current_best_platform: "amazon_fresh",
                    is_available_anywhere: true,
                    availability_status: {
                        "amazon_fresh": { in_stock: true, price: 18.00, url: "https://www.amazon.sg/dp/B0076ZQLH8" }
                    },
                    notes: "è¥¿ç­ç‰™é¡¶çº§å“ç‰Œ1896å¹´"
                },
                {
                    id: 6,
                    brand: "RamÃ³n PeÃ±a",
                    name: "Sardines in Olive Oil Gold Line",
                    origin_country: "Spain",
                    size: "130g",
                    foodguard_score: 9,
                    weekly_target_qty: 2,
                    current_best_price: null,
                    current_best_platform: null,
                    is_available_anywhere: false,
                    availability_status: {},
                    notes: "æ²™ä¸é±¼ç½å¤´ç»ˆæå½¢æ€ï¼Œéœ€å›½é™…é…é€"
                }
            ];

            renderProducts(mockProducts);
            updateStats(mockProducts);
            renderAlerts([]);
            updateLastChecked();
        }

        function renderProducts(products) {
            const container = document.getElementById('products-container');

            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— ç›‘æ§äº§å“</h3>
                        <p>è¯·å…ˆæ·»åŠ éœ€è¦ç›‘æ§çš„äº§å“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = products.map(product => {
                const image = PRODUCT_IMAGES[product.brand] || DEFAULT_IMAGE;
                const isAvailable = product.is_available_anywhere ||
                    Object.values(product.availability_status || {}).some(s => s.in_stock);
                const price = product.current_best_price;
                const platform = product.current_best_platform;

                // Generate platform links
                const platformLinks = Object.entries(product.availability_status || {})
                    .map(([p, status]) => {
                        const available = status.in_stock;
                        const displayName = getPlatformName(p);
                        const priceText = status.price ? ` S$${status.price.toFixed(2)}` : '';
                        return `
                            <a href="${status.url || '#'}"
                               target="_blank"
                               class="platform-link ${available ? 'available' : 'unavailable'}">
                                ${displayName}${priceText}
                            </a>
                        `;
                    }).join('');

                return `
                    <div class="product-card">
                        <div class="product-image">
                            <img src="${image}" alt="${product.name}"
                                 onerror="this.src='${DEFAULT_IMAGE}'">
                            <span class="product-badge ${isAvailable ? 'badge-in-stock' : 'badge-out-of-stock'}">
                                ${isAvailable ? 'æœ‰è´§' : 'ç¼ºè´§'}
                            </span>
                            <div class="foodguard-score">
                                ğŸ† <span class="score-value">${product.foodguard_score || '-'}/10</span>
                            </div>
                        </div>
                        <div class="product-content">
                            <div class="product-brand">${product.brand}</div>
                            <h3 class="product-name">${product.name}</h3>
                            <div class="product-meta">
                                <span>ğŸŒ ${product.origin_country || 'æœªçŸ¥'}</span>
                                <span>ğŸ“¦ ${product.size || '-'}</span>
                                <span>ğŸ¯ ${product.weekly_target_qty || 2}ç›’/å‘¨</span>
                            </div>
                            ${price ? `
                                <div class="product-price">S$${price.toFixed(2)}</div>
                                <div class="product-platform">
                                    æœ€ä½ä»·å¹³å°: ${getPlatformName(platform)}
                                </div>
                            ` : `
                                <div class="product-price" style="color: var(--text-secondary);">æš‚æ— æŠ¥ä»·</div>
                            `}
                            ${product.notes ? `<p style="margin-top: 10px; font-size: 0.85em; color: var(--text-secondary);">${product.notes}</p>` : ''}
                            <div class="platform-links">
                                ${platformLinks || '<span style="color: var(--text-secondary); font-size: 0.85em;">æš‚æ— æ¸ é“ä¿¡æ¯</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alerts-container');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— æ–°æé†’</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = alerts.slice(0, 5).map(alert => {
                const icon = alert.alert_type === 'restock' ? 'ğŸ‰' : 'ğŸ’°';
                const time = new Date(alert.created_at).toLocaleString('zh-CN');
                return `
                    <div class="alert-card ${alert.alert_type}">
                        <div class="alert-content">
                            <span class="alert-icon">${icon}</span>
                            <div>
                                <div>${alert.message}</div>
                                <div class="alert-time">${time}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(products) {
            const total = products.length;
            const available = products.filter(p =>
                p.is_available_anywhere ||
                Object.values(p.availability_status || {}).some(s => s.in_stock)
            ).length;
            const unavailable = total - available;

            const totalCost = products.reduce((sum, p) => {
                if (p.current_best_price && p.weekly_target_qty) {
                    return sum + (p.current_best_price * p.weekly_target_qty);
                }
                return sum;
            }, 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-available').textContent = available;
            document.getElementById('stat-unavailable').textContent = unavailable;
            document.getElementById('stat-cost').textContent = totalCost.toFixed(2);
        }

        function updateLastChecked() {
            const now = new Date().toLocaleString('zh-CN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `æ›´æ–°: ${now}`;
        }

        function getPlatformName(platform) {
            const names = {
                'amazon_sg': 'Amazon SG',
                'lazada_sg': 'Lazada',
                'shopee_sg': 'Shopee',
                'redmart': 'RedMart',
                'fairprice': 'FairPrice',
                'cold_storage': 'Cold Storage',
                'little_farms': 'Little Farms',
                'fossa': 'Fossa',
                'morning_market': 'Morning Market',
                'amazon_fresh': 'Amazon Fresh'
            };
            return names[platform] || platform;
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            const loading = document.getElementById('loading');

            btn.disabled = true;
            loading.classList.add('active');

            try {
                if (API_BASE_URL) {
                    await fetch(`${API_BASE_URL}/api/watchlist/check`, { method: 'POST' });
                }
                await fetchData();
            } catch (e) {
                console.error('Refresh failed:', e);
            } finally {
                btn.disabled = false;
                loading.classList.remove('active');
            }
        }
    </script>
</body>
</html>
